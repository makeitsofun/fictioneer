function fcn_validateCss(t){if("string"!=typeof t)return!1;if(t=t.replace(/^\uFEFF/,""),/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/.test(t))return!1;if(t.includes("<"))return!1;const n=t.replace(/\/\*[\s\S]*?\*\//g,""),i=n.replace(/(["'])(?:\\.|(?!\1)[\s\S])*?\1/g,'""');if((i.match(/{/g)||[]).length!==(i.match(/}/g)||[]).length)return!1;function s(t){try{const n=new URL(t);return"https:"===n.protocol&&"fonts.googleapis.com"===n.hostname&&n.pathname.startsWith("/css")}catch{return!1}}if(!function(t){const n=/@import\s+(?:url\s*\(\s*)?(?:"([^"]+)"|'([^']+)'|([^"')\s]+))\s*\)?\s*;/gi;let i;for(;null!==(i=n.exec(t));){if(!s((i[1]||i[2]||i[3]||"").trim()))return!1}return!0}(n))return!1;const e=i.toLowerCase();if(e.includes("</style")||e.includes("<style")||/expression\s*\(/.test(e)||/-moz-binding\b/.test(e)||/\bbehavior\s*:/.test(e))return!1;const a=/url\s*\(\s*([^)]+?)\s*\)/gi;let c;for(;null!==(c=a.exec(n));){let t=c[1].trim();(t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))&&(t=t.slice(1,-1));const n=t.trim().toLowerCase();if(n.startsWith("javascript:"))return!1;if(n.startsWith("data:")){if(!/^(data:(image\/(png|jpeg|jpg|gif|webp|svg\+xml)|font\/(woff|woff2)|application\/font-woff2);)/i.test(n))return!1}}return!0}function fcn_getSkins(){const t=FcnUtils.getCookie("fcnLoggedIn");if(!t)return null;const n={data:{},active:null,fingerprint:t},i=FcnUtils.parseJSON(localStorage.getItem("fcnSkins"))??n;return i?.fingerprint&&t===i.fingerprint?(("object"!=typeof i.data||Array.isArray(i.data))&&(i.data={}),i):n}function fcn_setSkins(t){"object"!=typeof t||null===t||"object"!=typeof t.data||Array.isArray(t.data)?fcn_showNotification(fcn_skinTranslations.invalidJson,3,"warning"):t?.fingerprint&&FcnUtils.getCookie("fcnLoggedIn")===t.fingerprint?localStorage.setItem("fcnSkins",JSON.stringify(t)):fcn_showNotification(fcn_skinTranslations.wrongFingerprint,3,"warning")}function fcn_getSkinInfo(t){const n=t.match(/Name:\s*(.+)/),i=t.match(/Author:\s*(.+)/),s=t.match(/Version:\s*(.+)/);return{name:n?FcnUtils.sanitizeHTML(n[1].trim()):null,author:i?FcnUtils.sanitizeHTML(i[1].trim()):null,version:s?FcnUtils.sanitizeHTML(s[1].trim()):null}}function fcn_toggleSkin(t){const n=t.closest('[data-css-skin-finder="skin-item"]'),i=fcn_getSkins();n.classList.contains("active")?(_$$('[data-css-skin-finder="skin-item"]').forEach((t=>t.classList.remove("active"))),i.active=null):(_$$('[data-css-skin-finder="skin-item"]').forEach((t=>t.classList.remove("active"))),n.classList.add("active"),i.active=t.dataset.skinId),fcn_setSkins(i),fcn_applySkin()}function fcn_deleteSkin(t){const n=t.closest('[data-css-skin-finder="skin-item"]'),i=fcn_getSkins();n.classList.contains("active")&&(i.active=null),delete i.data[t.dataset.skinId],_$('[data-css-skin-target="file"]').value="",fcn_setSkins(i),fcn_renderSkinList(),fcn_applySkin()}function fcn_applySkin(){const t=FcnUtils.getCookie("fcnLoggedIn");if(!t||_$("body.wp-admin"))return;const n=fcn_getSkins();if(_$$$("fictioneer-active-custom-skin")?.remove(),n?.fingerprint===t&&n?.data?.[n.active]?.css){const t=document.createElement("style");t.textContent=n.data[n.active].css,t.id="fictioneer-active-custom-skin",_$("head").appendChild(t)}}function fcn_renderSkinList(){const t=_$('[data-css-skin-target="list"]'),n=FcnUtils.getCookie("fcnLoggedIn");if(!n||!t)return;const i=fcn_getSkins();t.innerHTML="",i?.fingerprint===n?(i?.data&&Object.keys(i.data).length>0&&(Object.entries(i.data).forEach((([n,s])=>{const e=_$('[data-css-skin-target="template"]').content.cloneNode(!0);i.active===n&&e.querySelector('[data-css-skin-finder="skin-item"]').classList.add("active"),e.querySelector('[data-action="click->css-skin#toggle"]').dataset.skinId=n,e.querySelector('[data-action="click->css-skin#delete"]').dataset.skinId=n,e.querySelector('[data-css-skin-finder="name"]').innerText=s.name,e.querySelector('[data-css-skin-finder="version"]').innerText=s.version,e.querySelector('[data-css-skin-finder="author"]').innerText=s.author,t.appendChild(e)})),_$$('[data-action="click->css-skin#toggle"]').forEach((t=>{t.addEventListener("click",(t=>fcn_toggleSkin(t.currentTarget)))})),_$$('[data-action="click->css-skin#delete"]').forEach((t=>{t.addEventListener("click",(t=>fcn_deleteSkin(t.currentTarget)))}))),Object.keys(i.data).length>2?_$('[data-css-skin-target="form"]').style.display="none":_$('[data-css-skin-target="form"]').style.display=""):_$('[data-css-skin-target="form"]').style.display=""}function fcn_uploadSkins(t){if(!FcnUtils.loggedIn()||t.classList.contains("disabled"))return;const n=fcn_getSkins();_$('[data-css-skin-target="action-status-message"]').classList.add("invisible"),FcnUtils.remoteAction("fictioneer_ajax_save_skins",{element:t,payload:{skins:JSON.stringify(n)},callback:t=>{t.success&&(fcn_showNotification(t.data.message,3,"success"),fcn_toggleSkinNotice(_$('[data-css-skin-target="action-status-message"]')))},finalCallback:()=>{_$('[data-css-skin-target="file"]').value=""}})}function fcn_downloadSkins(t){FcnUtils.loggedIn()&&!t.classList.contains("disabled")&&(_$('[data-css-skin-target="action-status-message"]').classList.add("invisible"),FcnUtils.remoteAction("fictioneer_ajax_get_skins",{element:t,callback:t=>{t.success&&(fcn_showNotification(t.data.message,3,"success"),fcn_toggleSkinNotice(_$('[data-css-skin-target="action-status-message"]')),fcn_setSkins(FcnUtils.parseJSON(t.data.skins)),fcn_renderSkinList(),fcn_applySkin())},finalCallback:()=>{_$('[data-css-skin-target="file"]').value="",_$$(".custom-skin button[disabled]").forEach((t=>t.disabled=!1))}}))}function fcn_toggleSkinNotice(t){t.classList.remove("invisible"),setTimeout((()=>{t.classList.add("invisible")}),3e3)}fcn_renderSkinList(),_$('[data-css-skin-target="file"]')?.addEventListener("input",(t=>{t.preventDefault();const n=t.currentTarget.files[0],i=fcn_getSkins(),s=FcnUtils.getCookie("fcnLoggedIn");if(Object.keys(i.data).length>2)return void fcn_showNotification(fcn_skinTranslations.tooManySkins,3,"warning");if(i?.fingerprint!==s)return void fcn_showNotification(fcn_skinTranslations.wrongFingerprint,3,"warning");if(!n)return;if(n.size>2e5)return void fcn_showNotification(fcn_skinTranslations.fileTooLarge,3,"warning");if("text/css"!==n.type)return void fcn_showNotification(fcn_skinTranslations.wrongFileType,3,"warning");const e=new FileReader;e.onload=t=>{const n=t.target.result,i=fcn_getSkinInfo(n),s=fcn_getSkins();if(!fcn_validateCss(n))return void fcn_showNotification(fcn_skinTranslations.invalidCss,5,"warning");if(!i.name)return void fcn_showNotification(fcn_skinTranslations.missingMetaData,3,"warning");const e=btoa(i.name);s.data[e]={name:i.name,version:i.version,author:i.author,css:n},fcn_setSkins(s),fcn_renderSkinList(),_$$(".custom-skin button[disabled]").forEach((t=>t.disabled=!1))},e.onerror=()=>{console.error(e.error),fcn_showNotification(e.error,3,"warning")},e.readAsText(n)})),_$('[data-action="click->css-skin#upload"]')?.addEventListener("click",(t=>{fcn_uploadSkins(t.currentTarget)})),_$('[data-action="click->css-skin#download"]')?.addEventListener("click",(t=>{fcn_downloadSkins(t.currentTarget)}));